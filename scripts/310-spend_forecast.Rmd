---
title: "R Notebook"
output: html_notebook
---

```{r}
library(dplyr)
library(knitr)
library(tidyverse)
library(stringr)
library(here)
library(fs)
library(readxl)

source(here("scripts", "set_vars.R"))
```

```{r}
gts_current_ctry_NES <- read_rds(here("output_data", "gts_current_ctry_NES.rds")) #current gts for Canada

spend_data3 <- read_rds(here("output_data", "spend_data3.rds"))
spend_pro_data3 <- read_rds(here("output_data", "spend_pro_data3.rds"))

ctry_v <- read_rds(here("output_data", "ctry_v.rds"))
low_lev_reg_v <- read_rds(here("output_data", "low_lev_reg_v.rds"))
non_US_v <- read_rds(here("output_data", "non_US_v.rds"))
final_df_v<- read_rds(here("output_data", "final_df_v.rds"))

ctry_def <- read_rds(here("output_data", "ctry_def.rds"))
```

#A concept similar to adr
```{r}
test1_can <- spend_pro_data3 %>%
  filter(area_of_residence == "Residents of countries other than the United States of America" & year <= 2023 & geo == "Canada") %>%
  group_by(year, geo) %>%
  summarise(s_can = sum(value, na.rm = TRUE), .groups = "drop") %>%
  ungroup()

#gap between Canada and sum of provinces
test1 <- spend_pro_data3 %>%
  filter(area_of_residence == "Residents of countries other than the United States of America" & year <= 2023 & geo != "Canada") %>%
  group_by(year) %>%
  summarise(s_sum = sum(value, na.rm = TRUE), .groups = "drop") %>%
  ungroup() %>%
  left_join(test1_can, by = c("year")) %>%
  mutate(gap = s_can - s_sum)

# #sum Yukon, nw territories, and Nunavut
# agg_pro_1 <- final_df_v %>%
#   filter((geo == "Northwest Territories" | geo == "Nunavut" | geo == "Yukon") & country_of_residence == "Total international") %>%
#   group_by(date) %>%
#   mutate(value = sum(value, na.rm = TRUE), .groups = "drop") %>%
#   ungroup() %>%
#   mutate(geo2 = "Yukon, Northwest Territories and Nunavut") %>%
#   select(geo, geo2, date, v = value)
# 
# agg_pro_2 <- final_df_v %>%
#   filter(geo != "Northwest Territories" & geo != "Nunavut" & geo != "Yukon" & country_of_residence == "Total international") %>%
#   select(geo, date, v = value) %>%
#   mutate(geo2 = geo, .after = geo) %>%
#   rbind(agg_pro_1) %>%
#   rename(geo_true = geo)
# 
# #spend per visit is not very consistent and comparable
# adr <- spend_pro_data3 %>%
#   filter(area_of_residence == "Non-resident visitors to Canada" & year <= 2023) %>%
#   group_by(year, geo) %>%
#   summarise(s = sum(value, na.rm = TRUE), .groups = "drop") %>%
#   ungroup() %>%
#   mutate(date = as.Date(paste0(year, "-01-01"))) %>%
#   left_join(agg_pro_2, by = c("geo" = "geo2", "date")) %>%
#   mutate(spend_per = s/v) %>%
#   filter(geo != "Canada")
# 
# adr_can <- adr %>%
#   select(geo, s, v, date) %>%
#   distinct() %>%
#   group_by(date) %>%
#   summarise(s = sum(s, na.rm = TRUE),
#             v = sum(v, na.rm = TRUE),
#             .groups = "drop") %>%
#   ungroup() %>%
#   mutate(spend_per_can = s/v)
# 
# adr_complete <- adr %>%
#   left_join(select(adr_can, date, spend_per_can), by = c("date")) %>%
#   mutate(adr_pct = spend_per/spend_per_can) %>%
#   select(geo = geo_true, date, s, v, spend_per, spend_per_can, adr_pct)
```

#country, rest of region, region to Canada history
```{r}
s_hist1 <- spend_data3 %>%
  group_by(year, geo, area_of_residence) %>%
  summarise(value = sum(value, na.rm = TRUE), .groups = "drop") %>%
  ungroup() %>%
  filter(area_of_residence != "United States of America residents" & area_of_residence != "United States of America residents, excursionists (same-day)" & area_of_residence != "Non-resident visitors to Canada")
  # left_join(ctry_def, by = c("area_of_residence" = "stat_can_ttl"))
```

#country, rest of region, region to Canada history, filter <= 2023
```{r}
s_hist2 <- s_hist1 %>%
  #mutate(orig_code = ifelse(area_of_residence == "United States of America residents, tourists (overnight)", "USA", orig_code)) %>%
  filter(year <= 2023) %>%
  mutate(date = as.Date(paste0(year, "-01-01"))) %>%
  select(-year)
```

#test if countries and rest of region sum up to region
#there's gap
#the aggregation is bigger than region, becuase region is missing for some period while countries have numbers.
#I'll overwrite region
```{r}
reg_agg <- data.frame(s_ttl= c("Brazil", "Caribbean", "Mexico", "Americas, countries other than the United States of America - other countries", "Belgium", "France", "Germany", "Italy", "Netherlands", "Scandinavia", "Switzerland", "United Kingdom", "Europe - other countries", "Northern Africa", "Africa - other countries", "Australia", "China", "Hong Kong", "India", "Japan", "New Zealand", "Southern Asia", "Asia and Oceania - other countries"),
                       s_reg=c("Americas, countries other than the United States of America", "Americas, countries other than the United States of America", "Americas, countries other than the United States of America", "Americas, countries other than the United States of America", "Europe", "Europe", "Europe", "Europe", "Europe", "Europe", "Europe", "Europe", "Europe", "Africa", "Africa", "Asia and Oceania", "Asia and Oceania", "Asia and Oceania", "Asia and Oceania", "Asia and Oceania", "Asia and Oceania", "Asia and Oceania", "Asia and Oceania"))


test_reg <- s_hist2 %>%
  filter(!(area_of_residence %in% c("United States of America residents, tourists (overnight)", "Residents of countries other than the United States of America", "Americas, countries other than the United States of America", "Europe", "Africa", "Asia and Oceania"))) %>%
  left_join(reg_agg, by = c("area_of_residence" = "s_ttl")) %>%
  group_by(geo, s_reg, date) %>%
  summarise(value_agg = sum(value, na.rm = TRUE), .groups = "drop") %>%
  ungroup() %>%
  left_join(s_hist2, by = c("geo", "s_reg" = "area_of_residence", "date")) %>%
  mutate(gap = value - value_agg)
  
```

#test if region sum up to overseas
#there's gap
#the aggregation is sig smaller than region during 2020-2022, other years is just 3-4 difference. I consider this as a residual.
#I'll calculate NES as a residual but I won't do the forecast for it.
```{r}
test_ovs <- test_reg %>%
  select(-c(value, gap)) %>%
  group_by(geo, date) %>%
  summarise(value_agg = sum(value_agg, na.rm = TRUE), .groups = "drop") %>%
  ungroup() %>%
  mutate(s_reg = "Residents of countries other than the United States of America") %>%
  left_join(s_hist2, by = c("geo", "s_reg" = "area_of_residence", "date")) %>%
  mutate(gap = value - value_agg)
```

```{r}
#Add Antarctica and Adjacent Islands, Iran and rest of southern Asia
list1 <- c("United States of America residents entering Canada", "Brazil", "Caribbean", "Mexico", "Belgium", "France", "Germany", "Italy", "Netherlands", "Denmark", "Finland", "Iceland", "Norway", "Sweden", "Switzerland", "United Kingdom", "Northern Africa", "Australia", "China", "Hong Kong", "India", "Japan", "New Zealand", "Iran", "Rest of Southern Asia", "Americas, countries other than the United States of America", "Europe", "Africa", "Asia", "Oceania", "Antarctica and Adjacent Islands")

list2 <- c("United States of America residents entering Canada", "Brazil", "Caribbean", "Mexico", "Belgium", "France", "Germany", "Italy", "Netherlands", "Switzerland", "United Kingdom", "Northern Africa", "Australia", "China", "Hong Kong", "India", "Japan", "New Zealand") # took out scandinavia and southern Asia
```

#prepare visits
```{r}
org_ctry <- final_df_v %>%
  filter(country_of_residence %in% list1) %>%
  select(geo, country_of_residence, date, value)

scan <- org_ctry %>%
  filter(country_of_residence %in% c("Denmark", "Finland", "Iceland", "Norway", "Sweden")) %>%
  group_by(geo, date) %>%
  summarise(value = sum(value, na.rm = TRUE), .groups = "drop") %>%
  ungroup() %>%
  mutate(country_of_residence = "Scandinavia", .after = geo)

sas <- org_ctry %>%
  filter(country_of_residence %in% c("Iran", "Rest of Southern Asia")) %>%
  group_by(geo, date) %>%
  summarise(value = sum(value, na.rm = TRUE), .groups = "drop") %>%
  ungroup() %>%
  mutate(country_of_residence = "Southern Asia", .after = geo)


rest_ame <- org_ctry %>%
  filter(country_of_residence %in% c("Brazil", "Caribbean", "Mexico")) %>%
  group_by(geo, date) %>%
  summarise(value_sum = sum(value, na.rm = TRUE), .groups = "drop") %>%
  ungroup() %>%
  left_join(org_ctry %>% filter(country_of_residence == "Americas, countries other than the United States of America"), by = c("geo", "date")) %>%
  mutate(country_of_residence = "Americas, countries other than the United States of America - other countries",
         value_rest = value - value_sum) %>%
  select(geo, country_of_residence, date, value = value_rest)

rest_eur <- org_ctry %>%
  filter(country_of_residence %in% c("Belgium", "France", "Germany", "Italy", "Netherlands", "Denmark", "Finland", "Iceland", "Norway", "Sweden", "Switzerland", "United Kingdom")) %>%
  group_by(geo, date) %>%
  summarise(value_sum = sum(value, na.rm = TRUE), .groups = "drop") %>%
  ungroup() %>%
  left_join(org_ctry %>% filter(country_of_residence == "Europe"), by = c("geo", "date")) %>%
  mutate(country_of_residence = "Europe - other countries",
         value_rest = value - value_sum) %>%
  select(geo, country_of_residence, date, value = value_rest)

rest_afr <- org_ctry %>%
  filter(country_of_residence %in% c("Northern Africa")) %>%
  rename(value_sum = value) %>%
  left_join(org_ctry %>% filter(country_of_residence == "Africa"), by = c("geo", "date")) %>%
  mutate(country_of_residence = "Africa - other countries",
         value_rest = value - value_sum) %>%
  select(geo, country_of_residence, date, value = value_rest)

#Asia and Oceania
rest_as <- org_ctry %>%
  filter(country_of_residence %in% c("Australia", "China", "Hong Kong", "India", "Japan", "New Zealand", "Iran", "Rest of Southern Asia")) %>%
  group_by(geo, date) %>%
  summarise(value_sum = sum(value, na.rm = TRUE), .groups = "drop") %>%
  ungroup() %>%
  left_join(org_ctry %>% 
              filter(country_of_residence %in% c("Asia", "Oceania")) %>%
              group_by(geo, date) %>%
              summarise(value = sum(value, na.rm = TRUE), .groups = "drop") %>%
              ungroup()
            , by = c("geo", "date")) %>%
  mutate(country_of_residence = "Asia and Oceania - other countries",
         value_rest = value - value_sum) %>%
  select(geo, country_of_residence, date, value = value_rest)

#Antarctica and Adjacent Islands
rest_at <- org_ctry %>%
  filter(country_of_residence == "Antarctica and Adjacent Islands") %>%
  mutate(country_of_residence = "Antarctica and Adjacent Islands - other countries")

final_org_ctry_v <- final_df_v %>%
  filter(country_of_residence %in% list2) %>%
  select(geo, country_of_residence, date, value) %>%
  rbind(scan, sas, rest_ame, rest_eur, rest_afr, rest_as, rest_at) %>%
  rename(v = value) %>%
  mutate(country_of_residence = ifelse(country_of_residence == "United States of America residents entering Canada", "United States of America residents, tourists (overnight)", country_of_residence))

```

#calculate Canada spend per visit for countries and rest of region
```{r}
s_hist3 <- final_org_ctry_v %>%
  filter(date >= "2018-01-01" & date <= "2023-01-01" & geo == "Canada") %>%
  left_join(s_hist2, by = c("geo", "country_of_residence" = "area_of_residence", "date")) %>%
  mutate(spend_per = value/v) %>%
  mutate(value = ifelse(is.na(value), 0, value),
         spend_per = ifelse(is.na(spend_per), 0, spend_per)) %>%
  rename(area_of_residence = country_of_residence)

s_residual <- s_hist3 %>%
  filter(area_of_residence != "United States of America residents, tourists (overnight)") %>%
  group_by(geo, date) %>%
  summarise(v = sum(v, na.rm = TRUE),
            value_agg = sum(value, na.rm = TRUE),
            .groups = "drop") %>%
  ungroup() %>%
  mutate(spend_per = value_agg/v) %>%
  mutate(area_of_residence = "Residents of countries other than the United States of America") %>%
  left_join(s_hist2, by = c("geo", "area_of_residence", "date")) %>%
  mutate(gap = value - value_agg,
         v = 0,
         spend_per = 0, 
         area_of_residence = "Not elsewhere specified") %>%
  mutate(gap = case_when(date == "2018-01-01" | date == "2023-01-01" ~ 0,
                         TRUE ~ gap)) %>%                                          #2018 and 2023 is negative, meaning sum of countries and rest of region is bigger than overseas, I'll overwrite overseas for these two years.
  select(geo, area_of_residence, date, v, value = gap, spend_per)

s_hist4 <- s_hist3 %>%
  rbind(s_residual)
```

#add USA and no Antartica
```{r}
ctry_def3 <- data.frame(orig_code= c("USA", "GRL", "MEX", "SPM", "BLZ", "CRI", "SLV", "GTM", "HND", "NIC", "PAN", "AIA", "ATG", "ABW", "BHS", "BRB", "BMU", "BES", "CYM", "CUB", "CUW", "DMA", "DOM", "GRD", "GLP", "HTI", "JAM", "MTQ", "MSR", "ANT", "PRI", "BLM", "KNA", "LCA", "MAF", "VCT", "SXM", "TTO", "TCA", "VGB", "VIR", "ARG", "BOL", "BRA", "CHL", "COL", "ECU", "FLK", "GUF", "GUY", "PRY", "PER", "SGS", "SUR", "URY", "VEN", "AUT", "BEL", "FRA", "DEU", "LIE", "LUX", "MCO", "NLD", "CHE", "ARM", "AZE", "BLR", "BGR", "CZE", "EST", "GEO", "HUN", "KAZ", "KGZ", "LVA", "LTU", "MDA", "POL", "ROU", "RUS", "SVK", "TJK", "TKM", "UKR", "UZB", "ALA", "DNK", "FRO", "FIN", "GGY", "ISL", "IRL", "IMN", "JEY", "NOR", "", "SJM", "SWE", "GBR", "ALB", "AND", "BIH", "HRV", "GIB", "GRC", "VAT", "ITA", "", "MLT", "MNE", "MKD", "PRT", "SMR", "SRB", "SVN", "ESP", "CYP", "ISR", "TUR", "BEN", "BFA", "CPV", "CIV", "GMB", "GHA", "GIN", "GNB", "LBR", "MLI", "MRT", "NER", "NGA", "SHN", "SEN", "SLE", "TGO", "IOT", "BDI", "COM", "DJI", "ERI", "ETH", "KEN", "MDG", "MWI", "MUS", "MYT", "MOZ", "REU", "RWA", "SYC", "SOM", "TZA", "UGA", "ZMB", "ZWE", "DZA", "MAR", "SSD", "SDN", "TUN", "ESH", "AGO", "CMR", "CAF", "TCD", "COD", "COG", "GNQ", "GAB", "STP", "BWA", "SWZ", "LSO", "NAM", "ZAF", "BHR", "EGY", "IRQ", "JOR", "KWT", "LBN", "LBY", "OMN", "QAT", "SAU", "SYR", "ARE", "", "YEM", "CHN", "HKG", "JPN", "PRK", "KOR", "MAC", "MNG", "TWN", "BRN", "KHM", "IDN", "LAO", "MYS", "MMR", "PHL", "SGP", "THA", "TLS", "VNM", "AFG", "BGD", "BTN", "IND", "IRN", "MDV", "NPL", "PAK", "LKA", "AUS", "NZL", "FJI", "NCL", "NFK", "PNG", "SLB", "VUT", "CXR", "CCK", "GUM", "KIR", "MHL", "FSM", "NRU", "MNP", "PLW", "UMI", "ASM", "COK", "PYF", "NIU", "PCN", "WSM", "TKL", "TON", "TUV", "WLF"),
                       s_ttl=c("United States of America residents, tourists (overnight)", "Americas, countries other than the United States of America - other countries", "Mexico", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean",
                               "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Caribbean", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Brazil", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", 
                               "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Americas, countries other than the United States of America - other countries", "Europe - other countries", "Belgium", "France", "Germany", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Netherlands",
                               "Switzerland", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries",
                               "Scandinavia", "Europe - other countries", "Scandinavia", "Europe - other countries", "Scandinavia", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Scandinavia", "Europe - other countries", "Europe - other countries", "Scandinavia", "United Kingdom", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Italy", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", 
                               "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Europe - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries",
                               "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Northern Africa", "Northern Africa", "Northern Africa",
                               "Northern Africa", "Northern Africa", "Northern Africa", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Africa - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries",
                               "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "China", "Hong Kong", "Japan", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", 
                               "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Southern Asia", "Southern Asia", "Southern Asia", "India", "Southern Asia", "Southern Asia", "Southern Asia", "Southern Asia", "Southern Asia", "Australia", "New Zealand", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", 
                               "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", 
                               "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries", 
                               "Asia and Oceania - other countries", "Asia and Oceania - other countries", "Asia and Oceania - other countries"))
```


```{r}
gts_s <- gts_current_ctry_NES %>%
  filter(variable == "s") %>%
  select(loc_code, date, orig_code, s = value)

gts_v <- gts_current_ctry_NES %>%
  filter(variable == "v") %>%
  select(loc_code, date, orig_code, v = value)

gts_spend_per <- gts_s %>%
  left_join(gts_v, by = c("loc_code", "date", "orig_code")) %>%
  left_join(ctry_def3, by = c("orig_code")) %>%
  group_by(loc_code, date, s_ttl) %>%
  summarise(s = sum(s, na.rm = TRUE),
            v= sum(v, na.rm = TRUE),
            .groups =  "drop") %>%
  ungroup() %>%
  mutate(gts_spend_per = s/v) %>%
  group_by(loc_code, s_ttl) %>%
  mutate(growth = gts_spend_per/gts_spend_per[date == "2023-01-01"]) %>%
  ungroup() %>%
  select(date, s_ttl, growth)

#use Netherlands to fill Belgium
gts_bel <- gts_spend_per %>%
  filter(s_ttl == "Netherlands") %>%
  mutate(s_ttl = "Belgium")

gts_spend_per_complete <- gts_spend_per %>%
  filter(s_ttl != "Belgium") %>%
  rbind(gts_bel)
```

#complete the date
```{r}
hold_geo <- ctry_v %>%
  select(geo) %>%
  filter(geo != "Canada") %>%
  distinct() %>%
  mutate(temp = 1) %>%
  add_row(geo = "Not specified province", temp = 1)

df_hold <- s_hist4 %>%
  select(date, area_of_residence) %>%
  mutate(temp = 1) %>%
  left_join(hold_geo, by = c("temp")) %>%
  complete(nesting(geo, area_of_residence,temp), date = seq.Date(from=as.Date("2018-01-01"), to=as.Date("2034-01-01"), by="year")) %>%
  select(-temp)
```
#calculate province's overseas spending ratio to total Canada
```{r}
##Overseas spending ratio
spend_pro_ovs <- spend_pro_data3 %>%
  filter(geo != "Canada") %>%
  group_by(year, geo, area_of_residence) %>%
  summarise(value = sum(value, na.rm = TRUE),
            .groups = "drop") %>%
  ungroup() %>%
  mutate(date = as.Date(paste0(year, "-01-01"))) %>%
  select(-year) %>%
  filter(area_of_residence == "Residents of countries other than the United States of America" & date <= "2023-01-01")

spend_can_ovs <- spend_pro_data3 %>%
  filter(geo == "Canada") %>%
  group_by(year, geo, area_of_residence) %>%
  summarise(value = sum(value, na.rm = TRUE),
            .groups = "drop") %>%
  ungroup() %>%
  mutate(date = as.Date(paste0(year, "-01-01"))) %>%
  select(-year) %>%
  filter(area_of_residence == "Residents of countries other than the United States of America" & date <= "2023-01-01")

#2022 sum of provinces is bigger than total Canada, I'll revise Canada
spend_nes_ovs <- spend_pro_ovs %>%
  group_by(area_of_residence, date) %>%
  summarise(sum_pro = sum(value, na.rm = TRUE), .groups = "drop") %>%
  ungroup() %>%
  mutate(geo = "Not specified province", .before = area_of_residence) %>%
  left_join(select(spend_can_ovs, can = value, date), by = c("date")) %>%
  mutate(value = can-sum_pro) %>%
  mutate(value = ifelse(value < 0, 0 , value)) %>%
  select(geo, area_of_residence, value, date)

#ratio for overseas
ratio_can_ovs <- spend_pro_ovs %>%
  rbind(spend_can_ovs, spend_nes_ovs) %>%
  group_by(area_of_residence, date) %>%
  mutate(ovs_ratio = value/value[geo == "Canada"]) %>%
  ungroup() %>%
  select(geo, date, ovs_ratio)

ratio_yukon_ovs <- ratio_can_ovs %>%
  filter(geo == "Yukon, Northwest Territories and Nunavut") %>%
  mutate(ovs_ratio = ovs_ratio/3, geo = "Yukon")

ratio_nw_ovs <- ratio_yukon_ovs %>%
  mutate(geo = "Northwest Territories")

ratio_nun_ovs <- ratio_yukon_ovs %>%
  mutate(geo = "Nunavut")





##US provinces spending ratio
spend_pro_us <- spend_pro_data3 %>%
  filter(geo != "Canada") %>%
  group_by(year, geo, area_of_residence) %>%
  summarise(value = sum(value, na.rm = TRUE),
            .groups = "drop") %>%
  ungroup() %>%
  mutate(date = as.Date(paste0(year, "-01-01"))) %>%
  select(-year) %>%
  filter(area_of_residence == "United States of America residents" & date <= "2023-01-01")

spend_can_us <- spend_pro_data3 %>%
  filter(geo == "Canada") %>%
  group_by(year, geo, area_of_residence) %>%
  summarise(value = sum(value, na.rm = TRUE),
            .groups = "drop") %>%
  ungroup() %>%
  mutate(date = as.Date(paste0(year, "-01-01"))) %>%
  select(-year) %>%
  filter(area_of_residence == "United States of America residents" & date <= "2023-01-01")


#2022 sum of provinces is bigger than total Canada, I'll revise Canada
spend_nes_us <- spend_pro_us %>%
  group_by(area_of_residence, date) %>%
  summarise(sum_pro = sum(value, na.rm = TRUE), .groups = "drop") %>%
  ungroup() %>%
  mutate(geo = "Not specified province", .before = area_of_residence) %>%
  left_join(select(spend_can_us, can = value, date), by = c("date")) %>%
  mutate(value = can-sum_pro) %>%
  mutate(value = ifelse(value < 0, 0 , value)) %>%
  select(geo, area_of_residence, value, date)




#ratio for us
ratio_can_us <- spend_pro_us %>%
  rbind(spend_can_us, spend_nes_us) %>%
  group_by(area_of_residence, date) %>%
  mutate(us_ratio = value/value[geo == "Canada"]) %>%
  ungroup() %>%
  select(geo, date, us_ratio)

ratio_yukon_us<- ratio_can_us %>%
  filter(geo == "Yukon, Northwest Territories and Nunavut") %>%
  mutate(us_ratio = us_ratio/3, geo = "Yukon")

ratio_nw_us <- ratio_yukon_us %>%
  mutate(geo = "Northwest Territories")

ratio_nun_us <- ratio_yukon_us %>%
  mutate(geo = "Nunavut")



ratio_ovs_complete <- ratio_can_ovs %>%
  filter(geo != "Yukon, Northwest Territories and Nunavut") %>%
  rbind(ratio_yukon_ovs, ratio_nw_ovs, ratio_nun_ovs)

ratio_us_complete <- ratio_can_us %>%
  filter(geo != "Yukon, Northwest Territories and Nunavut") %>%
  rbind(ratio_yukon_us, ratio_nw_us, ratio_nun_us)

ratio_can_complete <- ratio_ovs_complete %>%
  left_join(ratio_us_complete, by = c("geo", "date"))
```

#Method1
#country to provinces spending forecast complete
```{r}
ratio_control <- df_hold %>%
  left_join(final_org_ctry_v, by = c("geo", "area_of_residence" = "country_of_residence", "date")) %>%                          #visits
  left_join(ratio_can_complete, by = c("geo", "date")) %>%                                        #to forecast
  mutate(ratio = case_when(area_of_residence == "United States of America residents, tourists (overnight)" ~ us_ratio,
                           TRUE ~ ovs_ratio)) %>%
  select(-c(ovs_ratio, us_ratio)) %>%
  mutate(ratio = ifelse(v == 0 & area_of_residence != "Not elsewhere specified", 0, ratio)) %>%
  group_by(area_of_residence, date) %>%
  mutate(ratio_sum = sum(ratio, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(ratio = ratio/ratio_sum) %>%
  select(-c(v, ratio_sum))
  



s_pro_1 <- df_hold %>%
  left_join(final_org_ctry_v, by = c("geo", "area_of_residence" = "country_of_residence", "date")) %>%                          #visits
  left_join(select(s_hist4, date, area_of_residence, s = value), by = c("area_of_residence", "date")) %>%                       #spending
  left_join(ratio_control, by = c("geo", "area_of_residence", "date")) %>%                                                      #split total Canada
  left_join(gts_spend_per_complete, by = c("area_of_residence" = "s_ttl", "date")) %>% 
  mutate(v = ifelse(is.na(v), 0, v),
         revised_s = s*ratio,
         # revised_s = case_when(area_of_residence == "United States of America residents, tourists (overnight)" ~ s,           #the ratio is just to control for overseas
         #                       TRUE ~ s*ratio),
         revised_spend_per = ifelse(is.na(revised_s/v) | is.infinite(revised_s/v),0,revised_s/v)) %>%
  group_by(geo, area_of_residence) %>%
  mutate(revised_spend_per = case_when(date <= "2023-01-01" ~ revised_spend_per,
                               date >= "2024-01-01"~ revised_spend_per[date == "2023-01-01"] * growth)) %>%
  ungroup() %>%
  mutate(revised_s = case_when(area_of_residence == "Not elsewhere specified" ~ revised_s,
                               TRUE ~ v * revised_spend_per)) %>%
  select(-c(s, ratio, growth)) %>%
  mutate(revised_s = ifelse(is.na(revised_s), 0, revised_s),
         revised_spend_per = ifelse(is.na(revised_spend_per), 0, revised_spend_per)) %>%
  rename(s_forecast = revised_s)
  

s_can_1 <- s_pro_1 %>%
  group_by(area_of_residence, date) %>%
  summarise(v = sum(v, na.rm = TRUE),
            s_forecast = sum(s_forecast, na.rm = TRUE),
            .groups = "drop") %>%
  ungroup() %>%
  mutate(geo = "Canada", .before = area_of_residence) %>%
  mutate(revised_spend_per = ifelse(is.na(s_forecast/v) | is.infinite(s_forecast/v), 0, s_forecast/v), .before = s_forecast)

s_forecast <- s_pro_1 %>%
  rbind(s_can_1)
```


#See if sum of provinces matches history for countries into Canada 
```{r}
test2 <- s_can_1 %>%
  filter(date <= "2023-01-01") %>%
  left_join(s_hist4, by = c("geo", "area_of_residence", "date")) %>%
  mutate(gap_s = s_forecast - value)  #gap is very small, except Africa
```

```{r}
reg_def2 <- data.frame(s_ttl= c("Americas, countries other than the United States of America - other countries", "Mexico", "Caribbean", "Brazil", "Europe - other countries", "Belgium", "France", "Germany", "Netherlands", "Switzerland", "Scandinavia", "United Kingdom", "Italy", "Africa - other countries", "Northern Africa", "Asia and Oceania - other countries", "China", "Hong Kong", "Japan", "Southern Asia", "India", "Australia", "New Zealand", "Antarctica and Adjacent Islands - other countries"),
                             s_high_lev_reg=c("Americas, countries other than the United States of America", "Americas, countries other than the United States of America", "Americas, countries other than the United States of America", "Americas, countries other than the United States of America", "Europe", "Europe", "Europe", "Europe", "Europe", "Europe", "Europe", "Europe", "Europe", "Africa", "Africa", "Asia and Oceania", "Asia and Oceania", "Asia and Oceania", "Asia and Oceania", "Asia and Oceania", "Asia and Oceania", "Asia and Oceania", "Asia and Oceania", "Antarctica and Adjacent Islands"))
```

#aggregate region
```{r}
s_forecast_reg <- s_forecast %>%
  left_join(reg_def2, by = c("area_of_residence" = "s_ttl")) %>%
  filter(area_of_residence != "United States of America residents, tourists (overnight)" & area_of_residence != "Not elsewhere specified") %>%
  group_by(geo, s_high_lev_reg, date) %>%
  summarise(v = sum(v, na.rm = TRUE),
            s_forecast = sum(s_forecast, na.rm = TRUE),
            .groups = "drop") %>%
  ungroup() %>%
  mutate(revised_spend_per = s_forecast/v, .after = v) %>%
  rename(area_of_residence = s_high_lev_reg)

s_forecast_ovs <- s_forecast %>%
  filter(area_of_residence != "United States of America residents, tourists (overnight)") %>%
  group_by(geo, date) %>%
  summarise(v = sum(v, na.rm = TRUE),
            s_forecast = sum(s_forecast, na.rm = TRUE),
            .groups = "drop") %>%
  ungroup() %>%
  mutate(revised_spend_per = s_forecast/v, .after = v) %>%
  mutate(area_of_residence = "Residents of countries other than the United States of America", .after = geo)

s_forecast_tot <- s_forecast %>%
  filter(area_of_residence == "United States of America residents, tourists (overnight)") %>%
  rbind(s_forecast_ovs) %>%
  group_by(geo, date) %>%
  summarise(v = sum(v, na.rm = TRUE),
            s_forecast = sum(s_forecast, na.rm = TRUE),
            .groups = "drop") %>%
  ungroup() %>%
  mutate(revised_spend_per = s_forecast/v, .after = v) %>%
  mutate(area_of_residence = "Non-resident visitors to Canada", .after = geo)
```

```{r}
s_forecast_complete <- s_forecast %>%
  rbind(s_forecast_reg, s_forecast_ovs, s_forecast_tot) %>%
  mutate(revised_spend_per = ifelse(is.na(revised_spend_per), 0, revised_spend_per))
```


#see if province matches overseas history
```{r}
spend_pro_annual <- spend_pro_data3 %>%
  group_by(year, geo, area_of_residence) %>%
  summarise(value = sum(value, na.rm = TRUE),
            .groups = "drop") %>%
  ungroup() %>%
  mutate(date = as.Date(paste0(year, "-01-01"))) %>%
  select(-year) %>%
  mutate(ttl = ifelse(area_of_residence == "United States of America residents", "United States of America residents, tourists (overnight)", area_of_residence))
  
#aggregate 3 provinces to compare with overseas
s_forecast_3_pro <- s_forecast_complete %>%
  filter(area_of_residence %in% c("United States of America residents, tourists (overnight)", "Residents of countries other than the United States of America", "Non-resident visitors to Canada") & date <= "2023-01-01" & geo %in% c("Yukon", "Northwest Territories", "Nunavut")) %>%
  group_by(area_of_residence, date) %>%
  summarise(v = sum(v, na.rm = TRUE),
            s_forecast = sum(s_forecast, na.rm = TRUE),
            .groups = "drop") %>%
  ungroup() %>%
  mutate(revised_spend_per = ifelse(is.na(s_forecast/v) | is.infinite(s_forecast/v), 0, s_forecast/v)) %>%
  mutate(geo = "Yukon, Northwest Territories and Nunavut", .before = area_of_residence)
  
test3 <- s_forecast_complete %>%
  rbind(s_forecast_3_pro) %>%
  filter(area_of_residence %in% c("United States of America residents, tourists (overnight)", "Residents of countries other than the United States of America", "Non-resident visitors to Canada") & date <= "2023-01-01" & !(geo %in% c("Yukon", "Northwest Territories", "Nunavut"))) %>%
  left_join(spend_pro_annual, by = c("geo", "area_of_residence" = "ttl", "date")) %>%
  mutate(gap = value - s_forecast) %>%
  filter(area_of_residence == "Residents of countries other than the United States of America")
  
```

```{r}
colSums(is.na(s_forecast_complete))
```
#Method2
```{r}
# s_pro_1 <- df_hold %>%
#   left_join(final_org_ctry_v, by = c("geo", "area_of_residence" = "country_of_residence", "date")) %>%                          #visits
#   left_join(select(s_hist4, date, area_of_residence, s = value, spend_per), by = c("area_of_residence", "date")) %>%                       #spending
#   left_join(gts_spend_per_complete, by = c("area_of_residence" = "s_ttl", "date")) %>%                                          #to forecast
#   group_by(geo, area_of_residence) %>%
#   mutate(v = ifelse(is.na(v), 0, v),
#          revised_spend_per = case_when(date <= "2023-01-01" ~ spend_per,
#                                date >= "2024-01-01"~ spend_per[date == "2023-01-01"] * growth)) %>%
#   ungroup() %>%
#   mutate(s_forecast = case_when(area_of_residence == "Not elsewhere specified" ~ s,
#                                TRUE ~ v * revised_spend_per)) %>%
#   select(-c(spend_per, growth))
```

```{r}
write_rds(s_forecast_complete, here("output_data", "s_forecast_complete.rds"))
write.csv(s_forecast_complete, here(path(path_te_shared, path_output), "s_forecast_complete.csv"))
```

